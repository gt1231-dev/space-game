<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Step D - Coins & Shop (Recovery)</title>
<style>
  body{margin:0;background:#111;height:100vh;display:flex;justify-content:center;align-items:center}
  canvas{background:#0b1220;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.55);touch-action:none}
</style></head><body>
<canvas id="c" width="420" height="740"></canvas>
<script>
const c = document.getElementById("c");
const g = c.getContext("2d");

// ë…¼ë¦¬ ì¢Œí‘œê³„(ê²Œì„ì€ ì´ í¬ê¸°ë¡œ ê·¸ë¦¼)
const W = 420, H = 740;

// âœ… Retina/DPR ë³´ì •: ë‚´ë¶€ í”½ì…€ë§Œ í‚¤ìš°ê³ , ê·¸ë¦¬ëŠ” ì¢Œí‘œê³„ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
const DPR = window.devicePixelRatio || 1;
c.style.width = W + "px";
c.style.height = H + "px";
c.width = Math.round(W * DPR);
c.height = Math.round(H * DPR);

// ì´í›„ ëª¨ë“  drawëŠ” W/H ê¸°ì¤€ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ì“°ê¸°
g.setTransform(DPR, 0, 0, DPR, 0, 0);

// (ì„ íƒ) ì„ /í…ìŠ¤íŠ¸ ì•½ê°„ ë” ë§¤ëˆí•˜ê²Œ
g.imageSmoothingEnabled = true;

const LANES=3, laneX=i=>W*(i+.5)/LANES, clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const pick=a=>a[(Math.random()*a.length)|0];
const aabb=(ax,ay,aw,ah,bx,by,bw,bh)=>ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;
function formatShort(n){
  const sign = n < 0 ? "-" : "";
  n = Math.abs(n);

  const units = [
    {v: 1e9, s: "b"},
    {v: 1e6, s: "m"},
    {v: 1e3, s: "k"},
  ];

  for(const u of units){
    if(n >= u.v){
      const val = n / u.v;
      const txt = (Math.round(val * 10) / 10).toFixed(1).replace(/\.0$/, "");
      return sign + txt + u.s;
    }
  }
  return sign + String(n);
}

const BANK_KEY="lw_like_bank_v1";
const UP_KEY="lw_like_up_v1";

let bank=0;
try{ bank=Number(localStorage.getItem(BANK_KEY)||"0")||0; }catch{ bank=0; }

const up={ startTroops:10, dmg:6, rate:6 };
try{
  const raw=localStorage.getItem(UP_KEY);
  if(raw){
    const o=JSON.parse(raw);
    if(typeof o.startTroops==="number") up.startTroops=o.startTroops;
    if(typeof o.dmg==="number") up.dmg=o.dmg;
    if(typeof o.rate==="number") up.rate=o.rate;
  }
}catch{}

function saveAll(){
  try{ localStorage.setItem(BANK_KEY, String(bank)); }catch{}
  try{ localStorage.setItem(UP_KEY, JSON.stringify(up)); }catch{}
}

let mode="play"; // play | gameover | shop
let lane=1, target=1, troops=up.startTroops; // troops = ì ìˆ˜
let speed=240, t=0, coins=0;
let timeS = 0; // âœ… ì• ë‹ˆë©”ì´ì…˜ ì „ìš© ì‹œê°„(ìŠ¤í°íƒ€ì´ë¨¸ të‘ ë¶„ë¦¬)


// âœ… í”Œë ˆì´ì–´ HP(ì²´ë ¥)
let hp=60, maxHp=60;
// âœ… ìŠ¤í…Œì´ì§€(15ì´ˆë§ˆë‹¤ ìƒìŠ¹)
let stage = 0;         // 0,1,2...
let stageClock = 0;    // ëˆ„ì  ì‹œê°„
let stageFlash = 0;    // ìŠ¤í…Œì´ì§€ ì „í™˜ í‘œì‹œìš©(ì ê¹)



// bullets
const bullets=[]; let fireCd=0;
let fireAnim = 0; // âœ… ë°œì‚¬ ëª¨ì…˜ íƒ€ì´ë¨¸


// player/objects
const player={y:H-140,w:56,h:92}; // âœ… ë” ê¸¸ì­‰í•œ ìš°ì£¼ì„  ë¹„ìœ¨(ì„¸ë¡œ)
const objs=[]; // gate/enemy/coin

function resetRun(){
  mode="play";
  coins=0;
  troops=up.startTroops;
  lane=1; target=1;
  speed=240; t=0;
timeS = 0; // âœ… ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ ì´ˆê¸°í™”

  objs.length=0;
  bullets.length=0;
  fireCd=0;

  hp = maxHp; // âœ… ì²´ë ¥ ì´ˆê¸°í™”
    stage = 0;
  stageClock = 0;
  stageFlash = 0;


}


function spawnRow(){
  const l1=(Math.random()*3)|0, l2=(l1+1+((Math.random()*2)|0))%3;

  const kind=()=>{ const r=Math.random(); return r<.55?"add":r<.8?"mul":r<.92?"sub":"div"; };
  const val=(k)=>k==="add"?pick([5,10,15,20,25,30]):k==="mul"?pick([2,3,4]):k==="sub"?pick([5,10,15]):pick([2,3]);
  const makeGate=(ln)=>{ const k=kind(); return {type:"gate",lane:ln,y:-120,w:134,h:90,k,val:val(k),hit:false}; };
  objs.push(makeGate(l1), makeGate(l2));

  // coin
  objs.push({type:"coin",lane:(Math.random()*3)|0,y:-200,w:44,h:44,amt:pick([5,10,15,20]),hit:false});

    // enemies 1~2
   const twoChance = clamp(0.25 + stage*0.03, 0.25, 0.75); // ìŠ¤í…Œì´ì§€ ì˜¤ë¥¼ìˆ˜ë¡ 2ë§ˆë¦¬ í™•ë¥ â†‘
  const n = Math.random() < twoChance ? 2 : 1;

  for(let i=0;i<n;i++){
       const stageHp = stage * 3.2; // ìŠ¤í…Œì´ì§€ë‹¹ ì²´ë ¥ ìƒìŠ¹(ë„ˆë¬´ ì„¸ë©´ 3.2 -> 2.4)
    const baseHp = pick([12,16,22,30]) 
      + Math.floor(Math.sqrt(Math.max(0, troops)) / 12)   // ì ìˆ˜ ì˜í–¥ ì™„ë§Œí•˜ê²Œ ë„ˆí”„
      + Math.floor(stageHp);


    const lvl = Math.max(1, Math.round(baseHp / 6)); // HP ê¸°ë°˜ ë ˆë²¨(ì™¸í˜• ë‹¨ê³„)

    objs.push({
      type:"enemy",
      lane:(Math.random()*3)|0,
      y:-300-i*90,

      // ì¶©ëŒ íŒì •ì€ ê¸°ì¡´ì²˜ëŸ¼ ë„¤ëª¨ë¡œ ìœ ì§€(ê²Œì„ ë¡œì§ ì•ˆ ê¹¨ì§)
      w:72,h:72,

      hp: baseHp,
      maxHp: baseHp,
      lvl: lvl,

      hit:false
    });
  }
}

function endGame(){
  mode="gameover";
  bank += coins;       // ë‚¨ì€ ì´ë²ˆ ì½”ì¸ ëˆ„ì 
  saveAll();
}

function applyGate(o){
  if(o.k==="add") troops+=o.val;
  else if(o.k==="mul") troops*=o.val;
  else if(o.k==="sub") troops-=o.val;
  else troops=Math.floor(troops/o.val);
  troops=Math.max(0,Math.floor(troops));
  if(troops<=0){ troops=0; endGame(); }
}

function collectCoin(o){
  coins += o.amt;
  troops += Math.ceil(o.amt * 0.5); // âœ… ì ìˆ˜ëŠ” ì ˆë°˜ë§Œ
}

function takeDamage(amount){
  hp -= amount;
  if(hp <= 0){
    hp = 0;
    endGame();
  }
}



function hitEnemyBody(o){
  // âœ… ëª¸ë°• = ë‚´ ì ìˆ˜/ê³µê²©ë ¥ ê±´ë“œë¦¬ì§€ ì•Šê³  HPë§Œ ê¹ì„
  const base = Math.ceil(o.maxHp * 0.22);                 // ì ì´ ì…€ìˆ˜ë¡ ì•„í””
  const scale = Math.floor(Math.sqrt(Math.max(0, troops)) / 25); // ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ì¡°ê¸ˆ ë”(ì™„ë§Œ)
  const dmgToPlayer = clamp(base + scale, 4, 30);         // ê³¼ë„ ë°©ì§€

  // ëª¸ë°• ì‹œ ì ì€ ë°”ë¡œ ì œê±°(ë˜ëŠ” ì¡°ê¸ˆë§Œ ê¹ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ ì°¸ê³ )
  o.hp -= Math.ceil((up.dmg + 2) * 0.8);

  takeDamage(dmgToPlayer);
}


function hitEnemyBullet(o,dmg){
  o.hp -= dmg;
  if(o.hp <= 0){
    troops += Math.max(1, Math.floor(o.maxHp * 0.10)); // ì²˜ì¹˜ ë³´ìƒ = ì  ì²´ë ¥ ë¹„ë¡€
  }
}
function calcScorePower(){
  return Math.min(18, Math.floor(Math.sqrt(Math.max(0, troops)) / 22));
}


function tryShoot(){


  if(mode!=="play") return;
  if(fireCd>0) return;
  const ln=Math.round(target);
   // âœ… ì ìˆ˜ ê¸°ë°˜ ê³µê²© ë³´ì • ë„ˆí”„ + ìƒí•œ(í›„ë°˜ í­ì£¼ ë°©ì§€)
const scorePower = calcScorePower();


fireAnim = 0.10; // âœ… ë°œì‚¬ ëª¨ì…˜ ON
bullets.push({
  lane: ln,
  y: player.y - player.h/2 - 14,
  r: 5,
  v: 620,
  dmg: up.dmg + scorePower,
  t: 0 // âœ… ë¹„í–‰ ì‹œê°„(ê¼¬ë¦¬ ì• ë‹ˆë©”ì´ì…˜)
});


  // âœ… ì—°ì‚¬ ì‚´ì§ ë„ˆí”„(ë„ˆë¬´ ë¹ ë¥¸ ëŠë‚Œ ë°©ì§€) + í›„ë°˜ ê³¼ë„í•œ í­ì£¼ ë°©ì§€
  const effectiveRate = Math.max(2.5, up.rate * 0.85);
  fireCd = 1 / effectiveRate;

}

// ===== input =====
addEventListener("keydown",(e)=>{
  const k=e.key.toLowerCase();

  if(mode==="play"){
    if(k==="a"||e.key==="ArrowLeft") target=clamp(target-1,0,2);
    if(k==="d"||e.key==="ArrowRight") target=clamp(target+1,0,2);
  }

  // shop toggle (never resets)
  if(k==="b"){
    if(mode==="play") mode="shop";
    else if(mode==="shop") mode="play";
  }

  // space: play=shoot, gameover=restart
  if(e.code==="Space"){
    if(mode==="play") tryShoot();
    else if(mode==="gameover") resetRun();
    e.preventDefault();
  }
});

// click: play=shoot, gameover=restart
c.addEventListener("click",()=>{
  if(mode==="play") tryShoot();
  else if(mode==="gameover") resetRun();
});
// ===== mobile touch control =====
c.addEventListener("touchstart", onTouch, {passive:false});
c.addEventListener("touchmove", onTouch, {passive:false});

function onTouch(e){
  if(mode!=="play") return;

  const r = c.getBoundingClientRect();
  const t = e.touches[0];
  const x = (t.clientX - r.left) * (W / r.width);

  // í™”ë©´ 3ë“±ë¶„ â†’ ë ˆì¸ ê²°ì •
  if(x < W/3) target = 0;
  else if(x < W*2/3) target = 1;
  else target = 2;

  e.preventDefault();
}


// shop purchase click
c.addEventListener("mousedown",(e)=>{
  if(mode!=="shop") return;
  const r=c.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(W/r.width);
  const my=(e.clientY-r.top)*(H/r.height);

  // close box
  if(mx>=40 && mx<=W-40 && my>=90 && my<=130){ mode="play"; return; }

  const items=shopItems();
  const x0=40, y0=220, w0=W-80, rowH=62;   // <-- ê²¹ì¹¨ ë°©ì§€ë¡œ ì•„ë˜ë¡œ ë‚´ë¦¼
  for(let i=0;i<items.length;i++){
    const y=y0+i*rowH;
    if(mx>=x0 && mx<=x0+w0 && my>=y && my<=y+rowH-10){
      buy(items[i]);
      return;
    }
  }
});

function shopItems(){
  const c1=60 + (up.startTroops-10)*20;
  const c2=90 + (up.dmg-6)*35;
  const c3=120 + (up.rate-6)*50;
  return [
    {name:`ì‹œì‘ ë³‘ë ¥ +5 (í˜„ì¬ ${up.startTroops})`, cost:c1, act:()=>up.startTroops+=5},
    {name:`ì´ì•Œ ë°ë¯¸ì§€ +1 (í˜„ì¬ ${up.dmg})`, cost:c2, act:()=>up.dmg+=1},
    {name:`ì—°ì‚¬ +1/s (í˜„ì¬ ${up.rate}/s)`, cost:c3, act:()=>up.rate=Math.min(20, up.rate+1)},
  ];
}

// âœ… ì´ë²ˆ ì½”ì¸ ë¨¼ì € ì“°ê³ , ë¶€ì¡±í•˜ë©´ ëˆ„ì  ì½”ì¸ ì‚¬ìš©
function buy(it){
  let cost = it.cost;

  const useNow = Math.min(coins, cost);
  coins -= useNow;
  cost -= useNow;

  if (cost > 0) {
    if (bank < cost) {
      // êµ¬ë§¤ ì‹¤íŒ¨ â†’ ë˜ëŒë¦¬ê¸°
      coins += useNow;
      return;
    }
    bank -= cost;
  }

  it.act();
  saveAll();
}

// ===== enemy monster render =====
function enemyColor(lvl){
  // ë” ì§„í•œ(ì–´ë‘ìš´) ìƒ‰: ìˆ«ì ê°€ë…ì„± í™•ë³´ìš©
  const t = clamp(lvl / 18, 0, 1);
  const hue = 120 - 120*t + 35*(t*t);
  const sat = 92;
  const light = 26 - 8*t; // ì§„í•˜ê²Œ(ì–´ë‘¡ê²Œ)
  return `hsl(${hue}, ${sat}%, ${light}%)`;
}

function drawMonster(ctx, x, y, o, time){
  const lvl = o.lvl || 1;

  // ë ˆë²¨ ê¸°ë°˜ ì™¸í˜• ìŠ¤íƒ¯
  const size = clamp(22 + lvl*2.0, 22, 56);
  const spikes = clamp(2 + (lvl|0), 2, 14);
  const spikeLen = clamp(8 + lvl*0.8, 8, 24);
  const eyes = clamp(1 + Math.floor(lvl/4), 1, 4);
  const aura = clamp(0.06 + lvl*0.010, 0.06, 0.18);

  // ì•½í•œ ê¿ˆí‹€(ê°•í• ìˆ˜ë¡ ì¡°ê¸ˆ ë”)
  const wob = clamp(lvl*0.30, 0.2, 3.0);
  const wobX = Math.sin(time*7.2 + lvl) * wob;
  const wobY = Math.cos(time*6.1 + lvl) * wob;

  ctx.save();
  ctx.translate(x + wobX, y + wobY);

  // ì˜¤ë¼
  ctx.beginPath();
  ctx.arc(0, 0, size*1.22, 0, Math.PI*2);
  ctx.fillStyle = `rgba(255,80,80,${aura})`;
  ctx.fill();

  // ê°€ì‹œ
  ctx.beginPath();
  for(let i=0;i<spikes;i++){
    const a = (i/spikes) * Math.PI*2;
    const r1 = size*0.88;
    const r2 = r1 + spikeLen;
    const x1 = Math.cos(a)*r1, y1 = Math.sin(a)*r1;
    const x2 = Math.cos(a + Math.PI*2/(spikes*2))*r2, y2 = Math.sin(a + Math.PI*2/(spikes*2))*r2;
    const x3 = Math.cos(a + Math.PI*2/spikes)*r1, y3 = Math.sin(a + Math.PI*2/spikes)*r1;
    if(i===0) ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.lineTo(x3,y3);
  }
  ctx.closePath();
  ctx.fillStyle = "rgba(0,0,0,0.22)";
  ctx.fill();

  // ëª¸í†µ
  ctx.beginPath();
  ctx.arc(0, 0, size, 0, Math.PI*2);
  ctx.fillStyle = enemyColor(lvl);
  ctx.fill();

  // ëˆˆ
  for(let i=0;i<eyes;i++){
    const spread = (i - (eyes-1)/2) * (size*0.42);
    const ex = spread;
    const ey = -size*0.18;

    ctx.beginPath();
    ctx.arc(ex, ey, size*0.18, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.fill();

    const pr = clamp(size*(0.09 - lvl*0.002), size*0.04, size*0.09);
    ctx.beginPath();
    ctx.arc(ex + Math.sin(time*3 + i)*2, ey + Math.cos(time*2 + i)*1, pr, 0, Math.PI*2);
    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.fill();
  }

  // âœ… HP ìˆ«ìë§Œ ì¤‘ì•™ì— (ê°€ë…ì„±: ê²€ì€ í…Œë‘ë¦¬ + í°ìƒ‰)
  const hpTxt = formatShort(o.hp);
  const fontSize = clamp(16 + lvl*0.20, 16, 24);
  ctx.font = `900 ${fontSize}px system-ui`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  // ì•„ì£¼ ì•½í•œ ê·¸ë¦¼ì(ì„ íƒ)
  ctx.shadowColor = "rgba(0,0,0,0.55)";
  ctx.shadowBlur = 4;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 2;

  // âœ… ìˆ«ì í…Œë‘ë¦¬(ì¤‘ìš”)
  ctx.lineJoin = "round";
  ctx.miterLimit = 2;
  ctx.lineWidth = 7;                    // í…Œë‘ë¦¬ ë‘ê»ê²Œ
  ctx.strokeStyle = "rgba(0,0,0,0.95)";
  ctx.strokeText(hpTxt, 0, size*0.10);

  ctx.fillStyle = "rgba(255,255,255,0.98)";
  ctx.fillText(hpTxt, 0, size*0.10);

  // ê·¸ë¦¼ì ì´ˆê¸°í™”
  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 0;

  ctx.restore();
}

// ===== cute flat planet render =====
function drawPlanet(ctx, x, y, o, time){
  const lvl = o.lvl || 1;
  const type = (lvl - 1) % 8;          // 0~7 í–‰ì„± íƒ€ì… ìˆœí™˜
  // â­ í–‰ì„± í¬ê¸° ëŒ€í­ ì¦ê°€ (ì „ì²´ì ìœ¼ë¡œ ì•½ 2ë°°)
const r = clamp(44 + lvl*2.3, 44, 108);


  // ë‘¥ì‹¤ + ì‚´ì§ íšŒì „ ëŠë‚Œ(ë¬´ëŠ¬ê°€ ì›€ì§ì´ëŠ” ê²ƒì²˜ëŸ¼)
  const float = Math.sin(time*2.0 + type) * 1.4;
  const spin  = time*0.25 + type*0.6;

  // ì˜ˆì‹œ ì´ë¯¸ì§€ í†¤(íŒŒìŠ¤í…” + ì„ ëª…)
  const base = [
    "#F4A261", // ìˆ˜ì„±: íšŒê°ˆì£¼í™©
    "#F6D365", // ê¸ˆì„±: ë…¸ë‘
    "#8ED1E8", // ì§€êµ¬: í•˜ëŠ˜
    "#F07C6C", // í™”ì„±: ì½”ë„ë ˆë“œ
    "#F2C35B", // ëª©ì„±: ë¨¸ìŠ¤íƒ€ë“œ
    "#F1DCA7", // í† ì„±: ë² ì´ì§€
    "#A5E3E6", // ì²œì™•ì„±: ë¯¼íŠ¸
    "#5B86C6", // í•´ì™•ì„±: íŒŒë‘
  ][type];

  // ë¬´ëŠ¬ìƒ‰(ì‚´ì§ ì§„í•œ í†¤)
  const pat = [
    "rgba(180,120,80,0.45)",  // ìˆ˜ì„±
    "rgba(210,150,70,0.35)",  // ê¸ˆì„±
    "rgba(70,190,120,0.40)",  // ì§€êµ¬
    "rgba(170,70,60,0.45)",   // í™”ì„±
    "rgba(160,110,60,0.35)",  // ëª©ì„±
    "rgba(180,150,90,0.30)",  // í† ì„±
    "rgba(70,140,150,0.35)",  // ì²œì™•ì„±
    "rgba(40,80,130,0.35)",   // í•´ì™•ì„±
  ][type];

  ctx.save();
  ctx.translate(x, y + float);

  // ===== ë³¸ì²´ =====
  ctx.beginPath();
  ctx.arc(0, 0, r, 0, Math.PI*2);
  ctx.fillStyle = base;
  ctx.fill();

  // ===== í•˜ì´ë¼ì´íŠ¸(ì˜ˆì‹œ ì´ë¯¸ì§€ ëŠë‚Œ) =====
  ctx.beginPath();
  ctx.arc(-r*0.28, -r*0.30, r*0.35, 0, Math.PI*2);
  ctx.fillStyle = "rgba(255,255,255,0.22)";
  ctx.fill();

  // ===== ì› ë‚´ë¶€ í´ë¦½í•´ì„œ ë¬´ëŠ¬ ë„£ê¸° =====
  ctx.save();
  ctx.beginPath();
  ctx.arc(0, 0, r, 0, Math.PI*2);
  ctx.clip();

  // 0/3: í¬ë ˆì´í„° (ìˆ˜ì„±/í™”ì„±/ë‹¬ ëŠë‚Œ)
  if(type === 0 || type === 3){
    ctx.fillStyle = pat;
    const pts = [
      [-0.35, -0.05, 0.18],
      [ 0.20, -0.25, 0.14],
      [ 0.28,  0.18, 0.16],
      [-0.10,  0.28, 0.12],
    ];
    for(const [px,py,pr] of pts){
      ctx.beginPath();
      ctx.arc(px*r, py*r, pr*r, 0, Math.PI*2);
      ctx.fill();
      // í¬ë ˆì´í„° ì•ˆìª½ ìŒì˜
      ctx.beginPath();
      ctx.arc(px*r - pr*r*0.2, py*r - pr*r*0.2, pr*r*0.6, 0, Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,0.10)";
      ctx.fill();
      ctx.fillStyle = pat;
    }
  }

  // 1: ê¸ˆì„± ëŠë‚Œ ëŒ€ê° ë°´ë“œ
  if(type === 1){
    ctx.save();
    ctx.rotate(-0.5);
    ctx.fillStyle = pat;
    for(let i=-2;i<=2;i++){
      ctx.globalAlpha = (i%2===0) ? 0.28 : 0.18;
      ctx.fillRect(-r*1.4, i*r*0.34, r*2.8, r*0.14);
    }
    ctx.restore();
    ctx.globalAlpha = 1;
  }

  // 2: ì§€êµ¬ ëŠë‚Œ(ëŒ€ë¥™ 2ë©ì´ + ì–‡ì€ êµ¬ë¦„)
  if(type === 2){
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = pat;
    ctx.beginPath();
    ctx.ellipse(-r*0.22, -r*0.05, r*0.55, r*0.28, 0.25, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(r*0.24, r*0.20, r*0.42, r*0.24, -0.55, 0, Math.PI*2);
    ctx.fill();

    ctx.globalAlpha = 0.35;
    ctx.strokeStyle = "rgba(255,255,255,0.65)";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.arc(0, 0, r*0.72, 0.3, Math.PI-0.3);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  // 4: ëª©ì„± ì¤„ë¬´ëŠ¬(í™•ì‹¤í•˜ê²Œ)
  if(type === 4){
    ctx.save();
    ctx.rotate(0.15);
    for(let i=-3;i<=3;i++){
      ctx.fillStyle = (i%2===0) ? "rgba(255,255,255,0.18)" : pat;
      ctx.fillRect(-r*1.4, i*r*0.28, r*2.8, r*0.16);
    }
    ctx.restore();
  }

  // 6/7: ì²œì™•ì„±/í•´ì™•ì„± ì–‡ì€ ë§/ë¼ì¸
  if(type === 6 || type === 7){
    ctx.strokeStyle = "rgba(255,255,255,0.22)";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.arc(0, 0, r*0.72, 0.25, Math.PI-0.25);
    ctx.stroke();

    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = "rgba(0,0,0,0.18)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(0, 0, r*0.55, 0.35, Math.PI-0.35);
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  ctx.restore(); // clip ë

  // 5: í† ì„± ë§(í´ë¦½ ë°–ì—ì„œ í¬ê²Œ)
  if(type === 5){
    ctx.save();
    ctx.rotate(-0.35);
    ctx.strokeStyle = "rgba(255,255,255,0.55)";
    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.ellipse(0, 0, r*1.55, r*0.62, 0, 0, Math.PI*2);
    ctx.stroke();

    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.ellipse(0, 0, r*1.30, r*0.52, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // ===== ëˆˆì•Œ 2ê°œ (HPë‘ ì•ˆ ê²¹ì¹˜ê²Œ ìœ„ìª½) =====
  const eyeY = -r*0.12;
  const eyeX = r*0.20;

  // ëˆˆ í°ì
  ctx.fillStyle = "rgba(255,255,255,0.95)";
  ctx.beginPath(); ctx.arc(-eyeX, eyeY, r*0.16, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( eyeX, eyeY, r*0.16, 0, Math.PI*2); ctx.fill();

  // ë™ê³µ(ì‚´ì§ ì›€ì§ì„)
  const px = Math.sin(time*2.2 + type) * r*0.04;
  const py = Math.cos(time*2.0 + type) * r*0.03;
  ctx.fillStyle = "rgba(0,0,0,0.85)";
  ctx.beginPath(); ctx.arc(-eyeX + px, eyeY + py, r*0.06, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( eyeX + px, eyeY + py, r*0.06, 0, Math.PI*2); ctx.fill();

  // ===== HP ìˆ«ì (ì•„ë˜ìª½ìœ¼ë¡œ ë‚´ë ¤ì„œ ëˆˆ/ë¬´ëŠ¬ë‘ ë¶„ë¦¬) =====
  // ===== HP ìˆ«ì (ì•„ë˜ìª½, ì–‡ì€ ì™¸ê³½ì„ ) =====
const hpTxt = formatShort(o.hp);
const fontSize = Math.round(clamp(18 + lvl*0.15, 18, 28));
ctx.font = `900 ${fontSize}px system-ui`;

ctx.textAlign = "center";
ctx.textBaseline = "middle";

// ìˆ«ì ëª¨ì–‘ì„ ë”°ë¼ê°€ëŠ” ì•„ì£¼ ì–‡ì€ ìŠ¤íŠ¸ë¡œí¬
ctx.lineJoin = "round";
ctx.miterLimit = 2;
ctx.lineWidth = 7;                          // â­ ë§¤ìš° ì–‡ì€ í…Œë‘ë¦¬
ctx.strokeStyle = "rgba(0,0,0,0.55)";         // ì—°í•œ ê²€ì •
ctx.fillStyle = "rgba(255,255,255,0.98)";

const textY = Math.round(r * 0.40);

ctx.strokeText(hpTxt, 0, textY);
ctx.fillText(hpTxt, 0, textY);

  ctx.restore();
}

// ===== loop =====
let last=performance.now();
function loop(now){
  const dt=Math.min(.033,(now-last)/1000); last=now;

  if(mode==="play"){
  tryShoot(); // ğŸ”¥ ìë™ ê³µê²©
stageClock += dt;
timeS += dt; // âœ… ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ ëˆ„ì (ì ˆëŒ€ ë¦¬ì…‹ ì•ˆ ë¨)


     // âœ… ìŠ¤í…Œì´ì§€ ì‹œê°„(15ì´ˆë§ˆë‹¤ ìƒìŠ¹)
    if(stageClock >= 15){
  stageClock -= 15;
  stage++;
  stageFlash = 1.2;

  // âœ… ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ë³´ë„ˆìŠ¤ ì²´ë ¥ íšŒë³µ
  const heal = Math.max(4, Math.floor(maxHp * 0.12)); // 12%
  hp = Math.min(maxHp, hp + heal);
}

    

    // âœ… ë‚œì´ë„: ìŠ¤í…Œì´ì§€ê°€ ì˜¤ë¥¼ìˆ˜ë¡ ì†ë„ ì¦ê°€ ë” ë¹¨ë¼ì§
   const accel = 4.0 + stage * 0.95;
speed = Math.min(520, speed + dt * accel);


    // âœ… ë‚œì´ë„: ìŠ¤í…Œì´ì§€ê°€ ì˜¤ë¥¼ìˆ˜ë¡ ìŠ¤í° ë” ìì£¼(ìµœì†Œ 0.65ì´ˆê¹Œì§€)
   const spawnInterval = Math.max(0.72, 1.2 - stage * 0.055);
    t += dt;
    if(t > spawnInterval){ spawnRow(); t=0; }


    lane += (target-lane)*Math.min(1,dt*14);

    for(const o of objs) o.y += speed*dt;

    fireCd=Math.max(0,fireCd-dt);
    fireAnim = Math.max(0, fireAnim - dt);
        stageFlash = Math.max(0, stageFlash - dt);


    for(const b of bullets) b.y -= b.v*dt;
    for(const b of bullets) b.t += dt;


    const px=laneX(lane)-player.w/2, py=player.y-player.h/2;

    // player collisions
    for(const o of objs){
      if(o.hit) continue;
      const ox=laneX(o.lane)-o.w/2, oy=o.y-o.h/2;
      if(aabb(px,py,player.w,player.h,ox,oy,o.w,o.h)){
        o.hit=true;
        if(o.type==="gate") applyGate(o);
        else if(o.type==="coin") collectCoin(o);
        else hitEnemyBody(o);
      }
    }

    // bullet collisions (enemies)
    for(const b of bullets){
      if(b.y<-30) continue;
      for(const o of objs){
        if(o.type!=="enemy") continue;
        if(o.hp<=0) continue;
        if(o.lane!==b.lane) continue;
        const ox=laneX(o.lane)-o.w/2, oy=o.y-o.h/2;
        const bx=laneX(b.lane)-b.r, by=b.y-b.r;
        if(aabb(bx,by,b.r*2,b.r*2,ox,oy,o.w,o.h)){
          b.y=-9999;
          hitEnemyBullet(o,b.dmg);
          break;
        }
      }
    }

    // cleanup
    for(let i=objs.length-1;i>=0;i--){
      const o=objs[i];
      if(o.y>H+260) objs.splice(i,1);
      else if(o.hit) objs.splice(i,1);
      else if(o.type==="enemy" && o.hp<=0) objs.splice(i,1);
    }
    for(let i=bullets.length-1;i>=0;i--) if(bullets[i].y<-50) bullets.splice(i,1);
  }

  draw();
  requestAnimationFrame(loop);
}
function drawShip(ctx, xCenter, yCenter){
  const nowS = performance.now()/1000;

  const w = player.w;
  const h = player.h;

  const left = xCenter - w/2;
  const top  = yCenter - h/2;

  ctx.save();
  ctx.translate(left, top);

  // ===== ë¡œì¼“ ëª¸í†µ(ì„¸ë¡œí˜•) =====
  ctx.fillStyle = "rgba(245,245,245,.98)";
  rr(w*0.18, h*0.12, w*0.64, h*0.76, 20);
  ctx.fill();

  // ì½”(ë¹¨ê°•, ë” ë¾°ì¡±)
  ctx.beginPath();
  ctx.moveTo(w*0.50, 0);
  ctx.lineTo(w*0.74, h*0.18);
  ctx.lineTo(w*0.26, h*0.18);
  ctx.closePath();
  ctx.fillStyle = "rgba(255,60,60,.98)";
  ctx.fill();

  // ì°½ë¬¸(ìœ„ìª½)
  ctx.beginPath();
  ctx.arc(w*0.50, h*0.38, w*0.14, 0, Math.PI*2);
  ctx.fillStyle = "rgba(120,210,255,.98)";
  ctx.fill();
  ctx.lineWidth = 3;
  ctx.strokeStyle = "rgba(0,0,0,.20)";
  ctx.stroke();

  // ì˜† ë‚ ê°œ(ë¹¨ê°•)
  ctx.fillStyle = "rgba(255,60,60,.95)";
  ctx.beginPath();
  ctx.moveTo(w*0.18, h*0.62);
  ctx.lineTo(0,      h*0.82);
  ctx.lineTo(w*0.20, h*0.82);
  ctx.closePath();
  ctx.fill();

  ctx.beginPath();
  ctx.moveTo(w*0.82, h*0.62);
  ctx.lineTo(w,      h*0.82);
  ctx.lineTo(w*0.80, h*0.82);
  ctx.closePath();
  ctx.fill();

  // ë…¸ì¦(ì•„ë˜)
  ctx.fillStyle = "rgba(0,0,0,.35)";
  rr(w*0.40, h*0.84, w*0.20, h*0.10, 8);
  ctx.fill();

  // ë¶ˆê½ƒ(í•­ìƒ ì¡°ê¸ˆ, ë°œì‚¬ ìˆœê°„ ë” ê°•í•˜ê²Œ)
  const baseFlame = 10 + 5*Math.abs(Math.sin(nowS*6));
  const boost = fireAnim > 0 ? 16 : 0;
  const flameH = baseFlame + boost;

  ctx.globalAlpha = 0.9;
  ctx.beginPath();
  ctx.moveTo(w*0.50, h*0.95);
  ctx.quadraticCurveTo(w*0.38, h*0.98 + flameH, w*0.50, h*1.10 + flameH);
  ctx.quadraticCurveTo(w*0.62, h*0.98 + flameH, w*0.50, h*0.95);
  ctx.closePath();
  ctx.fillStyle = "rgba(255,160,30,.95)";
  ctx.fill();

  ctx.globalAlpha = 0.75;
  ctx.beginPath();
  ctx.moveTo(w*0.50, h*0.96);
  ctx.quadraticCurveTo(w*0.43, h*0.98 + flameH*0.65, w*0.50, h*1.05 + flameH*0.65);
  ctx.quadraticCurveTo(w*0.57, h*0.98 + flameH*0.65, w*0.50, h*0.96);
  ctx.closePath();
  ctx.fillStyle = "rgba(255,230,120,.95)";
  ctx.fill();
  ctx.globalAlpha = 1;

  // âœ… HP ë°” (í”Œë ˆì´ì–´ ì•„ë˜, ë¹¨ê°• + ì €ì²´ë ¥ ê¹œë¹¡) â€” ì˜¤ë¥¸ìª½ë¶€í„° ê¹ì„
  const barPad = 4;
  const barW = w - barPad*2;
  const barH = 8;
  const barX = barPad;
  const barY = h + 10;

  ctx.fillStyle = "rgba(0,0,0,.55)";
  rr(barX, barY, barW, barH, 4); ctx.fill();

  const hpRatio = clamp(hp / maxHp, 0, 1);

  let alpha = 1;
  if(hpRatio <= 0.30){
    alpha = 0.35 + 0.65 * Math.abs(Math.sin(nowS * 10));
  }
  ctx.globalAlpha = alpha;

  ctx.fillStyle = "rgba(255,60,60,.95)";
  rr(barX + barW*(1 - hpRatio), barY, barW*hpRatio, barH, 4);
  ctx.fill();

  ctx.globalAlpha = 1;
  ctx.restore();
}


function rr(x0,y0,w,h,r){
  r=Math.min(r,w/2,h/2); g.beginPath(); g.moveTo(x0+r,y0);
  g.arcTo(x0+w,y0,x0+w,y0+h,r); g.arcTo(x0+w,y0+h,x0,y0+h,r);
  g.arcTo(x0,y0+h,x0,y0,r); g.arcTo(x0,y0,x0+w,y0,r); g.closePath();
}

function draw(){
  // ===== STAGE ê¸°ë°˜ ë°°ê²½ (15ì´ˆ ë³´ê°„ + 10ì´ˆ ì˜ˆê³ ) =====
const stageRatio = clamp(stageClock / 15, 0, 1);
const nextWarn = stageClock > 10 ? (stageClock - 10) / 5 : 0;

const hueA = (210 + stage * 18) % 360;
const hueB = (210 + (stage + 1) * 18) % 360;

// âœ… hue ë³´ê°„(360ë„ ìµœë‹¨ê±°ë¦¬ë¡œ ë³´ê°„í•´ì„œ íŠ ë°©ì§€)
let dh = ((hueB - hueA + 540) % 360) - 180;  // -180~180
const hue = (hueA + dh * stageRatio + 360) % 360;


// ë°ê¸°: í›„ë°˜ 5ì´ˆì— ì‚´ì§ í”ë“¤ë¦¼
const baseLight = 12 + Math.min(6, stage * 0.35);
const warnPulse = nextWarn > 0 ? Math.sin(performance.now()/120) * 2 * nextWarn : 0;

// 1) ë°°ê²½ ë¨¼ì € ì¹ í•˜ê¸°
g.fillStyle = `hsl(${hue}, 40%, ${baseLight + warnPulse}%)`;
g.fillRect(0,0,W,H);

// 2) ê·¸ ë‹¤ìŒ ì˜ˆê³  ì˜¤ë²„ë ˆì´
if(mode==="play" && stageClock > 10){
  const p = (stageClock - 10) / 5;
  g.save();
  g.globalAlpha = 0.12 + 0.28 * p;
  g.fillStyle = "rgba(255,255,255,.18)";
  g.fillRect(0,0,W,H);
  g.restore();
}


  g.globalAlpha=.25; g.strokeStyle="#6aa6ff";
  for(let i=1;i<LANES;i++){ g.beginPath(); g.moveTo(W*i/LANES,0); g.lineTo(W*i/LANES,H); g.stroke(); }
  g.globalAlpha=1;

  // HUD
  g.fillStyle="rgba(255,255,255,.92)"; g.font="900 20px system-ui";
  g.fillText(`ì ìˆ˜: ${formatShort(troops)}`,14,30);
const scorePowerHUD = calcScorePower();
g.fillText(`ê³µê²©ë ¥: ${up.dmg + scorePowerHUD}`, 14, 56);





  g.font="800 16px system-ui";
  g.fillText(`ì´ë²ˆ ì½”ì¸: ${coins} | ëˆ„ì : ${bank}`,14,82);



  // state hint (no overlap/confusion)
  g.font="800 13px system-ui";
  if(mode==="play") g.fillText("ê³µê²©: Space/í´ë¦­  Â·  ìƒì : B",14,106);
  else if(mode==="gameover") g.fillText("ì¬ì‹œì‘: Space/í´ë¦­",14,106);
  else if(mode==="shop") g.fillText("ìƒì : í´ë¦­ìœ¼ë¡œ êµ¬ë§¤  Â·  ë‹«ê¸°: B",14,106);

  // small shop badge
  g.globalAlpha=.9;
  g.fillStyle="rgba(255,255,255,.10)";
  rr(W-108,14,94,34,12); g.fill();
  g.fillStyle="rgba(255,255,255,.85)";
  g.font="900 14px system-ui"; g.textAlign="center"; g.textBaseline="middle";
  g.fillText("ìƒì (B)",W-61,31);
  g.textAlign="left"; g.textBaseline="alphabetic";
  g.globalAlpha=1;

  // objects
  for(const o of objs){
    const x=laneX(o.lane);
    if(o.type==="gate"){
      const col=o.k==="add"?"rgba(80,200,120,.85)":o.k==="mul"?"rgba(120,140,255,.85)":o.k==="sub"?"rgba(255,160,80,.9)":"rgba(200,90,255,.85)";
      g.fillStyle=col; rr(x-o.w/2,o.y-o.h/2,o.w,o.h,16); g.fill();
      g.fillStyle="rgba(0,0,0,.65)"; g.font="900 26px system-ui"; g.textAlign="center"; g.textBaseline="middle";
      const txt=o.k==="add"?`+${o.val}`:o.k==="mul"?`Ã—${o.val}`:o.k==="sub"?`-${o.val}`:`Ã·${o.val}`;
      g.fillText(txt,x,o.y);
      g.textAlign="left"; g.textBaseline="alphabetic";
    } else if(o.type==="coin"){
      g.fillStyle="rgba(255,210,70,.95)";
      g.beginPath(); g.arc(x,o.y,22,0,Math.PI*2); g.fill();
      g.fillStyle="rgba(0,0,0,.65)"; g.font="900 14px system-ui"; g.textAlign="center"; g.textBaseline="middle";
      g.fillText(`+${o.amt}`,x,o.y);
      g.textAlign="left"; g.textBaseline="alphabetic";
     } else {
  // enemy = í–‰ì„± ë Œë”ë§
  drawPlanet(g, x, o.y, o, timeS);
}
  }

  // bullets (ë ˆì´ì € ë°‘ì¤„ê¸°)
for(const b of bullets){
  const x = laneX(b.lane);
  const y = b.y;

  const t = (b.t || 0);
  const pulse = 0.6 + 0.4*Math.abs(Math.sin(t*18)); // ê¹œë¹¡ íŒŒí˜•
  const len = 44;        // ë ˆì´ì € ê¸¸ì´
  const w1  = 10;        // ë°”ê¹¥ ê¸€ë¡œìš° ë‘ê»˜
  const w2  = 4;         // ì½”ì–´ ë‘ê»˜

  // 1) ë°”ê¹¥ ê¸€ë¡œìš°(ë¶€ë“œëŸ¬ìš´ ë¹›ì¤„ê¸°)
  g.globalAlpha = 0.18 * pulse;
  g.strokeStyle = "rgba(120,210,255,1)";
  g.lineWidth = w1;
  g.lineCap = "round";
  g.beginPath();
  g.moveTo(x, y);
  g.lineTo(x, y - len);
  g.stroke();

  // 2) ì•ˆìª½ ê¸€ë¡œìš°(ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ)
  g.globalAlpha = 0.35 * pulse;
  g.strokeStyle = "rgba(170,235,255,1)";
  g.lineWidth = w1 * 0.55;
  g.beginPath();
  g.moveTo(x, y);
  g.lineTo(x, y - len);
  g.stroke();

  // 3) ì½”ì–´(í•˜ì–€ ì¤‘ì‹¬ ë¹”)
  g.globalAlpha = 0.95;
  g.strokeStyle = "rgba(255,255,255,1)";
  g.lineWidth = w2;
  g.beginPath();
  g.moveTo(x, y);
  g.lineTo(x, y - len);
  g.stroke();

  // 4) ë§¨ ì• â€œì â€ (ë ˆì´ì € íƒ„ë‘ ëŠë‚Œ)
  g.globalAlpha = 0.9;
  g.fillStyle = "rgba(255,255,255,1)";
  g.beginPath();
  g.arc(x, y - len, 4, 0, Math.PI*2);
  g.fill();

  g.globalAlpha = 1;
}


    // player (ìš°ì£¼ì„ )
  const px = laneX(lane);
  drawShip(g, px, player.y);

  g.textAlign="left";
  g.textBaseline="alphabetic";

  // âœ… ìŠ¤í…Œì´ì§€ ì „í™˜ í…ìŠ¤íŠ¸(ì ê¹)
  if(mode==="play" && stageFlash > 0){
    g.save();
    g.globalAlpha = Math.min(1, stageFlash / 1.2);
    g.fillStyle = "rgba(0,0,0,.45)";
    rr(W/2-120, H*0.22-28, 240, 56, 16); g.fill();
    g.fillStyle = "rgba(255,255,255,.95)";
    g.font = "900 22px system-ui";
    g.textAlign = "center";
    g.textBaseline = "middle";
    g.fillText(`STAGE ${stage+1}`, W/2, H*0.22);
    g.restore();
    g.textAlign="left";
    g.textBaseline="alphabetic";
  }


  if(mode==="gameover"){
    g.fillStyle="rgba(0,0,0,.55)"; g.fillRect(0,0,W,H);
    g.fillStyle="rgba(255,255,255,.95)"; g.font="900 34px system-ui";
    g.textAlign="center"; g.textBaseline="middle";
    g.fillText("GAME OVER",W/2,H/2-24);
    g.font="800 18px system-ui";
    g.fillText(`ì´ë²ˆ ì½”ì¸: ${coins}  (ëˆ„ì  ì €ì¥ë¨)`,W/2,H/2+8);
    g.fillText("Space/í´ë¦­ìœ¼ë¡œ ì¬ì‹œì‘",W/2,H/2+36);
    g.textAlign="left"; g.textBaseline="alphabetic";
  }

  if(mode==="shop") drawShop();
}

function drawShop(){
  g.fillStyle="rgba(0,0,0,.62)"; g.fillRect(0,0,W,H);
  g.fillStyle="rgba(255,255,255,.95)"; g.font="950 28px system-ui";
  g.textAlign="center"; g.textBaseline="middle";
  g.fillText("ìƒì  (í´ë¦­ìœ¼ë¡œ êµ¬ë§¤)",W/2,90);

  g.globalAlpha=.9;
  g.fillStyle="rgba(255,255,255,.12)";
  rr(40,90,W-80,40,14); g.fill();
  g.fillStyle="rgba(255,255,255,.85)";
  g.font="900 14px system-ui";
  g.fillText("ë‹«ê¸°(í´ë¦­) / B í‚¤ë¡œ ë‹«ê¸°",W/2,120);
  g.globalAlpha=1;

  g.textAlign="left"; g.textBaseline="alphabetic";
  g.font="900 18px system-ui"; g.fillStyle="rgba(255,255,255,.92)";
  g.fillText(`ì´ë²ˆ ì½”ì¸: ${coins}`, 40, 155);
  g.fillText(`ëˆ„ì  ì½”ì¸: ${bank}`, 40, 180);

  const items=shopItems();
  const x0=40,y0=220,w0=W-80,rowH=62;

  for(let i=0;i<items.length;i++){
    const it=items[i], y=y0+i*rowH;
    g.globalAlpha=.95;
    g.fillStyle="rgba(255,255,255,.10)"; rr(x0,y,w0,rowH-10,16); g.fill();
    g.fillStyle="rgba(255,255,255,.92)"; g.font="800 16px system-ui";
    g.fillText(it.name,x0+16,y+24);

    // êµ¬ë§¤ ê°€ëŠ¥ ì—¬ë¶€(ì´ë²ˆ+ëˆ„ì  í•©ì‚° ê¸°ì¤€)
    const canBuy = (coins + bank) >= it.cost;
    g.fillStyle = canBuy ? "rgba(80,200,120,.95)" : "rgba(255,120,120,.95)";
    g.font="900 16px system-ui"; g.textAlign="right";
    g.fillText(`${it.cost} ì½”ì¸`,x0+w0-16,y+24);
    g.textAlign="left";
  }
  g.globalAlpha=1;
}

resetRun();
requestAnimationFrame(loop);
</script></body></html>
